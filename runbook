#!/usr/bin/env bash
set -euo pipefail
RUNTIME="${HOME}/.runbook-cli/scripts/runbook_cli.mjs"
if [[ ! -f "$RUNTIME" ]]; then
  echo "runbook: runtime not installed at $RUNTIME" >&2
  exit 1
fi

ROOT="${RUNBOOK_REPO_ROOT:-}"
if [[ -z "$ROOT" ]]; then
  SEARCH_DIR="$PWD"
  while [[ "$SEARCH_DIR" != "/" ]]; do
    if [[ -f "$SEARCH_DIR/.runbook/phases.json" ]]; then
      ROOT="$SEARCH_DIR"
      break
    fi
    SEARCH_DIR="$(dirname "$SEARCH_DIR")"
  done
fi

if [[ -z "$ROOT" ]]; then
  echo "runbook: unable to locate repository root (.runbook/phases.json)." >&2
  exit 1
fi

exec env RUNBOOK_REPO_ROOT="$ROOT" node "$RUNTIME" "$@"

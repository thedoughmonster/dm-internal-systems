#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "${ROOT}" ]; then
  echo "Not inside a git repo (git rev-parse failed)."
  exit 1
fi

# Optional arg: output file path. Default: repo root / repo_tree.txt
OUTPUT="${1:-$ROOT/repo_tree.txt}"

cd "$ROOT"

IGNORE_REGEX="node_modules|.git|.next|dist|build|coverage|.vercel|.turbo|*.log"

if command -v tree >/dev/null 2>&1; then
  tree \
    -a \
    --dirsfirst \
    -I "$IGNORE_REGEX" \
    > "$OUTPUT"
else
  # Prune ignored directories so find does not traverse them.
  # Then print directories and files, sorted.
  find . \
    \( -path "./.git" -o -path "./node_modules" -o -path "./.next" -o -path "./dist" -o -path "./build" -o -path "./coverage" -o -path "./.vercel" -o -path "./.turbo" \) -prune -o \
    -type f -name "*.log" -prune -o \
    -print \
    | sort \
    > "$OUTPUT"
fi

echo "Directory tree written to $OUTPUT"

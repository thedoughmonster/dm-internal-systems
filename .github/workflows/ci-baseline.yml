name: CI Baseline

on:
  pull_request:
    branches:
      - dev
      - prod

jobs:
  repo-standards:
    name: repo-standards
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Validate runbook artifacts
        run: node .runbook/scripts/runbook_cli.mjs validate
      - name: Validate repository standards
        run: node ops_tooling/scripts/policy/validate_repo_standards.mjs

  lint:
    name: lint
    runs-on: ubuntu-latest
    needs:
      - repo-standards
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm --prefix apps/web ci
      - name: Run lint
        run: npm --prefix apps/web run lint

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    needs:
      - repo-standards
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm --prefix apps/web ci
      - name: Run typecheck
        run: npm --prefix apps/web run typecheck

  visual-regression:
    name: visual-regression
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
    env:
      CHROMATIC_PROJECT_TOKEN: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm --prefix apps/web ci
      - name: Run visual regression (Chromatic)
        if: ${{ env.CHROMATIC_PROJECT_TOKEN != '' }}
        uses: chromaui/action@v11
        with:
          projectToken: ${{ env.CHROMATIC_PROJECT_TOKEN }}
          workingDir: apps/web
          buildScriptName: storybook:build:ci
      - name: Skip visual regression (missing secret)
        if: ${{ env.CHROMATIC_PROJECT_TOKEN == '' }}
        run: echo "Skipping Chromatic visual regression because CHROMATIC_PROJECT_TOKEN is not configured."

  integration-test-testenv:
    name: integration-test-testenv
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
    env:
      SUPABASE_PROJECT_REF: dm_brain_test
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_NEXT_PUBLIC_SUPABASE_URL }}
      SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.TEST_SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm --prefix apps/web ci
      - name: Guard test environment
        run: ops_tooling/scripts/ci/check-test-env.sh
      - name: Run integration tests
        run: npm --prefix apps/web run test:integration

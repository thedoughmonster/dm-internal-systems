name: DB Migrate

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: supabase-db

    steps:
      - uses: actions/checkout@v4

      - name: Install psql
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply migrations
        env:
          PGHOST: db.loqnooocmcuthedsduch.supabase.co
          PGPORT: "5432"
          PGDATABASE: postgres
          PGUSER: postgres
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          set -euo pipefail

          IPV4=$(getent ahostsv4 "$PGHOST" | awk '{print $1; exit}')
          if [ -z "$IPV4" ]; then
            echo "Failed to resolve IPv4 for $PGHOST"
            exit 1
          fi

          export PGHOSTADDR="$IPV4"
          echo "Using IPv4 $PGHOSTADDR"

          shopt -s nullglob
          files=(db/migrations/*.sql)

          echo "Found ${#files[@]} migration file(s)"
          if [ ${#files[@]} -eq 0 ]; then
            echo "No migrations found. Exiting successfully."
            exit 0
          fi

          for f in "${files[@]}"; do
            echo "APPLY $f"
            psql -v ON_ERROR_STOP=1 -h "$PGHOSTADDR" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -f "$f"
          done

name: DB Migrate

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: supabase-db

    steps:
      - uses: actions/checkout@v4

      - name: Install psql
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Apply migrations
        env:
          PGHOST: aws-1-us-east-2.pooler.supabase.com
          PGPORT: "5432"
          PGDATABASE: postgres
          PGUSER: postgres.loqnooocmcuthedsduch
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          set -euo pipefail
          set -x

          pwd
          git rev-parse HEAD
          ls -la
          ls -la db || true
          ls -la db/migrations || true

          mapfile -t files < <(find db/migrations -maxdepth 1 -type f -name '*.sql' | sort)

          echo "Found ${#files[@]} migration file(s)"
          if [ ${#files[@]} -eq 0 ]; then
            echo "No migrations found. Exiting successfully."
            exit 0
          fi

          psql -v ON_ERROR_STOP=1 -c "select 1 as ok;"

          for f in "${files[@]}"; do
            echo "APPLY $f"
            psql -v ON_ERROR_STOP=1 -f "$f"
          done

{
  "kind": "directive_task",
  "schema_version": "1.0",
  "meta": {
    "id": "31e21183-1f66-479b-b866-08f812fa1111",
    "title": "Add deployment guardrail checks for environment and branch path",
    "status": "todo",
    "priority": "high",
    "session_priority": "medium",
    "owner": "operator",
    "assignee": "executor",
    "bucket": "todo",
    "created": "2026-02-11T08:30:31.000Z",
    "updated": "2026-02-11T08:53:05.000Z",
    "tags": [
      "guardrails",
      "deployment",
      "safety"
    ],
    "effort": "medium",
    "depends_on": [
      "d02843d9-18ac-4054-bd85-c24428a41110",
      "6e0843fb-4da3-40e3-8e2d-ad5c4a2b1108"
    ],
    "blocked_by": [],
    "related": [],
    "summary": "Add checks that block non-prod use of prod project and block prod deploy path outside approved branch.",
    "execution_model": "gpt-5.2-codex",
    "thinking_level": "high"
  },
  "task": {
    "objective": "Implement repository checks enforcing deployment model guardrails.",
    "constraints": [
      "Checks must fail closed.",
      "Avoid secret output in logs."
    ],
    "allowed_files": [
      {
        "path": "`scripts/ci/check-no-prod-in-nonprod.sh` (create)",
        "access": "edit"
      },
      {
        "path": "`scripts/ci/check-prod-branch-path.sh` (create)",
        "access": "edit"
      },
      {
        "path": "`.github/workflows/ci-baseline.yml` (edit)",
        "access": "edit"
      },
      {
        "path": "`docs/DEPLOYMENT_INFRA_STATUS.md` (edit)",
        "access": "edit"
      }
    ],
    "steps": [
      {
        "id": "step_1",
        "instruction": "Create `scripts/ci/check-no-prod-in-nonprod.sh` that fails when non-prod scopes reference prod project identifiers.",
        "files": [],
        "artifact": ""
      },
      {
        "id": "step_2",
        "instruction": "Create `scripts/ci/check-prod-branch-path.sh` that fails when production deployment context is not from branch `prod` or release path `dev` to `prod`.",
        "files": [],
        "artifact": ""
      },
      {
        "id": "step_3",
        "instruction": "Edit `.github/workflows/ci-baseline.yml` and add jobs for both guardrail scripts.",
        "files": [],
        "artifact": ""
      },
      {
        "id": "step_4",
        "instruction": "Name the new guardrail jobs clearly so they can be required in branch protection.",
        "files": [],
        "artifact": ""
      },
      {
        "id": "step_5",
        "instruction": "In `docs/DEPLOYMENT_INFRA_STATUS.md`, mark `TASK_11` as completed and record UTC timestamp.",
        "files": [],
        "artifact": ""
      }
    ],
    "validation": {
      "commands": [
        "test -s scripts/ci/check-no-prod-in-nonprod.sh",
        "test -s scripts/ci/check-prod-branch-path.sh",
        "rg -n \"check-no-prod|check-prod-branch\" .github/workflows/ci-baseline.yml"
      ]
    },
    "expected_output": [
      "Guardrail checks exist and are enforced in CI."
    ],
    "stop_conditions": [
      "Stop and ask operator if release path policy changes from `dev` to `prod`."
    ],
    "notes": []
  }
}

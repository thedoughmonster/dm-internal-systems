#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

node ops_tooling/scripts/policy/validate_repo_standards.mjs >/dev/null
node .runbook/scripts/runbook_cli.mjs validate >/dev/null

needs_web_checks=0

while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ -z "${local_sha:-}" ]]; then
    continue
  fi

  if [[ "$local_sha" =~ ^0+$ ]]; then
    continue
  fi

  if [[ -n "${remote_sha:-}" && ! "$remote_sha" =~ ^0+$ ]]; then
    range_files="$(git diff --name-only "$remote_sha" "$local_sha" || true)"
  else
    base="$(git merge-base "$local_sha" dev 2>/dev/null || true)"
    if [[ -n "$base" ]]; then
      range_files="$(git diff --name-only "$base" "$local_sha" || true)"
    else
      range_files="$(git diff-tree --no-commit-id --name-only -r "$local_sha" || true)"
    fi
  fi

  if echo "$range_files" | rg -q '^apps/web/'; then
    needs_web_checks=1
  fi
done

if [[ "$needs_web_checks" -eq 1 ]]; then
  npm --prefix apps/web run lint
  npm --prefix apps/web run typecheck
fi
